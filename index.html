<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Customs Tariff Calculator (BD FY 2025-26)</title>
    <style>
        :root {
            --primary-green: #10b981;
            --secondary-blue: #3b82f6;
            --dark-navy: #0f172a;
            --light-gray: #f8fafc;
            --border-color: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-gray);
            color: #1e293b;
            padding: 2rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        h1 {
            text-align: center;
            color: var(--dark-navy);
            margin-bottom: 1.5rem;
        }

        .input-group {
            margin-bottom: 1.25rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
        }

        button {
            background-color: var(--primary-green);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            width: 100%;
            margin-top: 1rem;
        }

        button:hover {
            background-color: #0da271;
        }

        .result {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #ecfdf5;
            border-left: 4px solid var(--primary-green);
            border-radius: 6px;
            display: none;
        }

        .result h2 {
            margin-bottom: 1rem;
            color: var(--dark-navy);
        }

        .tax-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .total {
            font-weight: bold;
            border-top: 1px dashed #10b981;
            padding-top: 0.5rem;
            margin-top: 0.5rem;
        }

        .status {
            margin-top: 1rem;
            padding: 0.5rem;
            background: #fffbeb;
            border-left: 3px solid #f59e0b;
            font-size: 0.9rem;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Customs Tariff Calculator (FY 2025-26)</h1>

        <!-- CSV URL Input -->
        <div class="input-group">
            <label for="csvUrl">Enter Public CSV URL (Google Sheets):</label>
            <input type="url" id="csvUrl" placeholder="https://docs.google.com/spreadsheets/d/.../export?format=csv" 
                   value="https://docs.google.com/spreadsheets/d/e/2PACX-1vTrBZSeQ-YGYBGz66IrcqooOmJ9ErQdDRj3iYqbgRw4hNRvjurOctn7lC83w4LCRtKQdhxsoXhYSEWf/pub?gid=2081232822&single=true&output=csv">
            <button type="button" onclick="loadTariffData()">Load Tariff Data</button>
            <div class="status" id="statusMsg"></div>
        </div>

        <div class="input-group">
            <label for="searchInput">Enter HS Code or Tariff Description:</label>
            <input type="text" id="searchInput" placeholder="e.g., 48119021" disabled>
        </div>
        <div class="input-group">
            <label for="assessableValue">Assessable Value (BDT):</label>
            <input type="number" id="assessableValue" placeholder="Enter value" min="0" step="any" disabled>
        </div>
        <button onclick="calculateTariff()" id="calcBtn" disabled>Calculate Total Tax & Duties</button>

        <div class="result" id="resultBox">
            <h2>Tariff Breakdown</h2>
            <div class="tax-row"><span>HS Code:</span><span id="res-hscode"></span></div>
            <div class="tax-row"><span>Description:</span><span id="res-desc"></span></div>
            <div class="tax-row"><span>CD (%):</span><span id="res-cd"></span></div>
            <div class="tax-row"><span>SD:</span><span id="res-sd"></span></div>
            <div class="tax-row"><span>VAT (%):</span><span id="res-vat"></span></div>
            <div class="tax-row"><span>AIT (%):</span><span id="res-ait"></span></div>
            <div class="tax-row"><span>RD (%):</span><span id="res-rd"></span></div>
            <div class="tax-row"><span>AT (%):</span><span id="res-at"></span></div>
            <div class="tax-row total"><span>Total Tax & Duties (BDT):</span><span id="res-total"></span></div>
            <div class="tax-row total"><span>Total Payable (BDT):</span><span id="res-payable"></span></div>
        </div>
    </div>

    <script>
        let tariffData = [];
        const statusEl = document.getElementById('statusMsg');
        const searchInput = document.getElementById('searchInput');
        const assessableValue = document.getElementById('assessableValue');
        const calcBtn = document.getElementById('calcBtn');

        function showStatus(msg, isError = false) {
            statusEl.textContent = msg;
            statusEl.style.display = 'block';
            statusEl.style.backgroundColor = isError ? '#fee' : '#fffbeb';
            statusEl.style.borderLeftColor = isError ? '#ef4444' : '#f59e0b';
        }

        async function loadTariffData() {
            const url = document.getElementById('csvUrl').value.trim();
            if (!url) {
                showStatus("Please enter a valid CSV URL.", true);
                return;
            }

            try {
                showStatus("Loading tariff data...");
                const response = await fetch(url);
                if (!response.ok) throw new Error("Failed to load CSV. Ensure the link is public and ends with /export?format=csv");
                const csvText = await response.text();
                tariffData = parseCSV(csvText);
                enableInputs();
                showStatus(`Loaded ${tariffData.length} tariff entries successfully!`, false);
            } catch (err) {
                console.error(err);
                showStatus("Error: " + err.message, true);
            }
        }

        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            const data = [];

            // Map expected columns
            const hsIndex = headers.indexOf('hs') !== -1 ? headers.indexOf('hs') :
                            headers.indexOf('hscode') !== -1 ? headers.indexOf('hscode') : -1;
            const descIndex = headers.findIndex(h => h.includes('desc') || h.includes('tarriff'));
            const cdIndex = headers.indexOf('cd');
            const sdIndex = headers.indexOf('sd');
            const vatIndex = headers.indexOf('vat');
            const aitIndex = headers.indexOf('ait');
            const rdIndex = headers.indexOf('rd');
            const atIndex = headers.indexOf('at');

            if (hsIndex === -1 || descIndex === -1) {
                throw new Error("CSV must contain 'hs' and 'desc' columns.");
            }

            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/); // Handle commas in quotes
                if (row.length < Math.max(hsIndex, descIndex, cdIndex, sdIndex, vatIndex, aitIndex, rdIndex, atIndex) + 1) continue;

                const hs = (row[hsIndex] || '').replace(/"/g, '').trim();
                const desc = (row[descIndex] || '').replace(/"/g, '').trim();
                if (!hs || !desc) continue;

                data.push({
                    hs,
                    desc,
                    cd: parseFloat(row[cdIndex]?.trim()) || 0,
                    sd: parseFloat(row[sdIndex]?.trim()) || 0,
                    vat: parseFloat(row[vatIndex]?.trim()) || 0,
                    ait: parseFloat(row[aitIndex]?.trim()) || 0,
                    rd: parseFloat(row[rdIndex]?.trim()) || 0,
                    at: parseFloat(row[atIndex]?.trim()) || 0
                });
            }
            return data;
        }

        function enableInputs() {
            searchInput.disabled = false;
            assessableValue.disabled = false;
            calcBtn.disabled = false;
        }

        function calculateTariff() {
            const input = document.getElementById('searchInput').value.trim().toLowerCase();
            const assessableValueNum = parseFloat(document.getElementById('assessableValue').value);

            if (!input) {
                alert("Please enter HS Code or Tariff Description.");
                return;
            }
            if (isNaN(assessableValueNum) || assessableValueNum <= 0) {
                alert("Please enter a valid Assessable Value.");
                return;
            }

            let item = null;
            const cleanInput = input.replace(/\s/g, '');

            // Exact HS match
            if (/^\d+$/.test(cleanInput)) {
                item = tariffData.find(d => d.hs.replace(/\s/g, '') === cleanInput);
            }

            // Fallback: description match
            if (!item) {
                item = tariffData.find(d =>
                    d.desc.toLowerCase().includes(input) ||
                    input.includes(d.hs.toLowerCase())
                );
            }

            const resultBox = document.getElementById('resultBox');
            if (!item) {
                resultBox.style.display = 'block';
                document.getElementById('res-hscode').textContent = "—";
                document.getElementById('res-desc').textContent = "No matching tariff found.";
                document.getElementById('res-cd').textContent = "—";
                document.getElementById('res-sd').textContent = "—";
                document.getElementById('res-vat').textContent = "—";
                document.getElementById('res-ait').textContent = "—";
                document.getElementById('res-rd').textContent = "—";
                document.getElementById('res-at').textContent = "—";
                document.getElementById('res-total').textContent = "—";
                document.getElementById('res-payable').textContent = "—";
                return;
            }

            // Calculate taxes
            const cdRate = item.cd || 0;
            const sdVal = item.sd || 0;
            const vatRate = item.vat || 0;
            const aitRate = item.ait || 0;
            const rdRate = item.rd || 0;
            const atRate = item.at || 0;

            const cdAmount = (cdRate / 100) * assessableValueNum;
            const sdAmount = (sdVal > 100) ? sdVal : (sdVal / 100) * assessableValueNum;
            const customsValue = assessableValueNum + cdAmount + sdAmount;
            const vatAmount = (vatRate / 100) * customsValue;
            const aitAmount = (aitRate / 100) * customsValue;
            const rdAmount = (rdRate / 100) * customsValue;
            const atAmount = (atRate / 100) * customsValue;

            const totalTax = cdAmount + sdAmount + vatAmount + aitAmount + rdAmount + atAmount;
            const totalPayable = assessableValueNum + totalTax;

            // Display results
            document.getElementById('res-hscode').textContent = item.hs;
            document.getElementById('res-desc').textContent = item.desc;
            document.getElementById('res-cd').textContent = `${cdRate}% → BDT ${cdAmount.toFixed(2)}`;
            document.getElementById('res-sd').textContent = (sdVal > 100 ? `Fixed BDT ${sdVal}` : `${sdVal}%`) + ` → BDT ${sdAmount.toFixed(2)}`;
            document.getElementById('res-vat').textContent = `${vatRate}% → BDT ${vatAmount.toFixed(2)}`;
            document.getElementById('res-ait').textContent = `${aitRate}% → BDT ${aitAmount.toFixed(2)}`;
            document.getElementById('res-rd').textContent = `${rdRate}% → BDT ${rdAmount.toFixed(2)}`;
            document.getElementById('res-at').textContent = `${atRate}% → BDT ${atAmount.toFixed(2)}`;
            document.getElementById('res-total').textContent = `BDT ${totalTax.toFixed(2)}`;
            document.getElementById('res-payable').textContent = `BDT ${totalPayable.toFixed(2)}`;

            resultBox.style.display = 'block';
        }
    </script>
</body>
</html>
