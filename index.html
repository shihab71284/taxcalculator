<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Customs Tariff Calculator (BD 2025-26)</title>
    <style>
        :root {
            --primary-green: #10b981;
            --secondary-blue: #3b82f6;
            --dark-navy: #0f172a;
            --light-gray: #f8fafc;
            --border-color: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-gray);
            color: #1e293b;
            padding: 2rem;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        h1 {
            text-align: center;
            color: var(--dark-navy);
            margin-bottom: 1.5rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--secondary-blue);
            font-weight: 600;
        }

        .error {
            text-align: center;
            padding: 1rem;
            color: #ef4444;
            background-color: #fee2e2;
            border-radius: 6px;
            margin: 1rem 0;
            display: none;
        }

        .input-group {
            margin-bottom: 1.25rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
        }

        .suggestions {
            border: 1px solid var(--border-color);
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border-radius: 0 0 6px 6px;
            display: none;
        }

        .suggestion-item {
            padding: 0.5rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }

        .suggestion-item:hover {
            background-color: var(--light-gray);
        }

        button {
            background-color: var(--primary-green);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            width: 100%;
            margin-top: 1rem;
        }

        button:hover {
            background-color: #0da271;
        }

        button:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
        }

        .result {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #ecfdf5;
            border-left: 4px solid var(--primary-green);
            border-radius: 6px;
            display: none;
        }

        .result h2 {
            margin-bottom: 1rem;
            color: var(--dark-navy);
        }

        .tax-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .total {
            font-weight: bold;
            border-top: 1px dashed #10b981;
            padding-top: 0.5rem;
            margin-top: 0.5rem;
        }

        .stats {
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #64748b;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Customs Tariff Calculator (FY 2025-26)</h1>
        
        <div class="loading" id="loading">Loading tariff data from Google Sheets...</div>
        <div class="error" id="error"></div>
        
        <div id="mainContent" style="display: none;">
            <div class="input-group">
                <label for="searchInput">Enter HS Code or Tariff Description:</label>
                <input type="text" id="searchInput" placeholder="e.g., 48119021 or 'Insulated paper'" autocomplete="off">
                <div class="suggestions" id="suggestions"></div>
            </div>
            <div class="input-group">
                <label for="assessableValue">Assessable Value (BDT):</label>
                <input type="number" id="assessableValue" placeholder="Enter value in BDT" min="0" step="any">
            </div>
            <button onclick="calculateTariff()" id="calculateBtn">Calculate Total Tax & Duties</button>

            <div class="result" id="resultBox">
                <h2>Tariff Breakdown</h2>
                <div class="tax-row"><span>HS Code:</span><span id="res-hscode"></span></div>
                <div class="tax-row"><span>Description:</span><span id="res-desc"></span></div>
                <div class="tax-row"><span>CD (Customs Duty):</span><span id="res-cd"></span></div>
                <div class="tax-row"><span>SD (Supplementary Duty):</span><span id="res-sd"></span></div>
                <div class="tax-row"><span>VAT (Value Added Tax):</span><span id="res-vat"></span></div>
                <div class="tax-row"><span>AIT (Advance Income Tax):</span><span id="res-ait"></span></div>
                <div class="tax-row"><span>RD (Regulatory Duty):</span><span id="res-rd"></span></div>
                <div class="tax-row"><span>AT (Advance Tax):</span><span id="res-at"></span></div>
                <div class="tax-row total"><span>Total Tax & Duties (BDT):</span><span id="res-total"></span></div>
                <div class="tax-row total"><span>Total Payable (BDT):</span><span id="res-payable"></span></div>
            </div>
            <div class="stats" id="stats"></div>
        </div>
    </div>

    <script>
        let tariffData = [];
        let isLoading = true;

        // Google Sheets CSV URL (replace with your published CSV URL)
        const GOOGLE_SHEETS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5oq5vunjn40wtJMr7Jc0slsUMY9x3966cAyQegabhWMssl4_QMli_QiVi_IxH99orfvP_MgwcP86g/pub?gid=1630460602&single=true&output=csv';
        
        // Fallback data in case Google Sheets fails to load
        const FALLBACK_DATA = [
            { hs: "48119021", desc: "Insulated paper", cd: 10, sd: 0, vat: 15, ait: 5, rd: 0, at: 5 },
            { hs: "48119029", desc: "Excl. Insulated paper imp. by VAT reg. electric fan/water pump motor manf. Ind.", cd: 10, sd: 0, vat: 15, ait: 5, rd: 0, at: 5 },
            { hs: "48119030", desc: "Base paper for melamine", cd: 5, sd: 0, vat: 15, ait: 5, rd: 0, at: 5 },
            { hs: "48119090", desc: "Other Paper,Paperboard,Cellulose Wadding And Webs Of Cellulose Fibres,Nes", cd: 25, sd: 0, vat: 15, ait: 5, rd: 3, at: 5 },
            { hs: "48120000", desc: "Filter Blocks, Slabs And Plates, Of Paper Pulp", cd: 10, sd: 0, vat: 15, ait: 5, rd: 0, at: 5 },
            { hs: "48131000", desc: "In the form of booklets or tubes", cd: 25, sd: 300, vat: 15, ait: 5, rd: 3, at: 5 },
            { hs: "33030000", desc: "Perfumes And Toilet Waters", cd: 25, sd: 30, vat: 15, ait: 20, rd: 20, at: 5 },
            { hs: "33041000", desc: "Lip Make-Up Preparations", cd: 25, sd: 45, vat: 15, ait: 5, rd: 20, at: 5 },
            { hs: "29152100", desc: "Acetic Acid", cd: 25, sd: 0, vat: 15, ait: 5, rd: 3, at: 5 },
            { hs: "87019210", desc: "Other Tracktor, of an engine power Exceeding 18 kW but not exceeding 37 kW", cd: 1, sd: 0, vat: 15, ait: 5, rd: 0, at: 5 },
            { hs: "72042900", desc: "Waste and scrap of alloy steel(excl. stainless)", cd: 0, sd: 0, vat: 1800, ait: 600, rd: 0, at: 5 },
            { hs: "03063110", desc: "Rock lobster and other sea crawfish(Palinurus spp., Panulirus spp., Jasus spp.)", cd: 0, sd: 0, vat: 0, ait: 0, rd: 0, at: 5 },
            { hs: "98010031", desc: "Air cond.machine; refrigerators or freezers; dish washer/washing machine/clothd Dryer", cd: 7000, sd: 0, vat: 0, ait: 5, rd: 0, at: 5 },
            { hs: "22030000", desc: "Beer Made From Malt", cd: 25, sd: 250, vat: 15, ait: 5, rd: 3, at: 5 },
            { hs: "17019900", desc: "Cane Or Beet Sugar, In Solid Form, Nes Including Chemically Kue Sucoose", cd: 4000, sd: 0, vat: 15, ait: 5, rd: 15, at: 5 }
        ];

        // Load data from Google Sheets on page load
        window.onload = async function() {
            try {
                await loadTariffData();
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load tariff data. Using fallback data.');
                tariffData = FALLBACK_DATA;
                isLoading = false;
                showMainContent();
            }
        };

        async function loadTariffData() {
            try {
                const response = await fetch(GOOGLE_SHEETS_CSV_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                tariffData = parseCSV(csvText);
                
                if (tariffData.length === 0) {
                    throw new Error('No data parsed from CSV');
                }
                
                isLoading = false;
                showMainContent();
                updateStats();
                
            } catch (error) {
                console.error('Error loading CSV:', error);
                throw error;
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().toUpperCase());
            
            // Find column indices
            const hsIndex = headers.findIndex(h => h === 'HSCODE');
            const descIndex = headers.findIndex(h => h === 'TARRIFF_DESCRIPTION');
            const cdIndex = headers.findIndex(h => h === 'CD');
            const sdIndex = headers.findIndex(h => h === 'SD');
            const vatIndex = headers.findIndex(h => h === 'VAT');
            const aitIndex = headers.findIndex(h => h === 'AIT');
            const rdIndex = headers.findIndex(h => h === 'RD');
            const atIndex = headers.findIndex(h => h === 'AT');

            if (hsIndex === -1 || descIndex === -1) {
                throw new Error('Required columns not found in CSV');
            }

            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                // Handle CSV parsing with quotes
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let char of line) {
                    if (char === '"' && inQuotes) {
                        inQuotes = false;
                    } else if (char === '"' && !inQuotes) {
                        inQuotes = true;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current); // Push last value

                const hsCode = values[hsIndex]?.replace(/"/g, '').trim();
                const description = values[descIndex]?.replace(/"/g, '').trim();

                if (hsCode && description) {
                    data.push({
                        hs: hsCode,
                        desc: description,
                        cd: parseFloat(values[cdIndex]) || 0,
                        sd: parseFloat(values[sdIndex]) || 0,
                        vat: parseFloat(values[vatIndex]) || 0,
                        ait: parseFloat(values[aitIndex]) || 0,
                        rd: parseFloat(values[rdIndex]) || 0,
                        at: parseFloat(values[atIndex]) || 0
                    });
                }
            }

            return data;
        }

        function showMainContent() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function updateStats() {
            document.getElementById('stats').textContent = `Loaded ${tariffData.length} tariff entries`;
        }

        // Search functionality with suggestions
        const searchInput = document.getElementById('searchInput');
        const suggestionsBox = document.getElementById('suggestions');

        searchInput.addEventListener('input', function() {
            const query = this.value.trim().toLowerCase();
            if (query.length < 2) {
                suggestionsBox.style.display = 'none';
                return;
            }

            const matches = tariffData.filter(item => 
                item.hs.toLowerCase().includes(query) || 
                item.desc.toLowerCase().includes(query)
            ).slice(0, 10);

            if (matches.length > 0) {
                suggestionsBox.innerHTML = '';
                matches.forEach(match => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.textContent = `${match.hs} - ${match.desc.substring(0, 60)}${match.desc.length > 60 ? '...' : ''}`;
                    div.onclick = function() {
                        searchInput.value = match.hs;
                        suggestionsBox.style.display = 'none';
                    };
                    suggestionsBox.appendChild(div);
                });
                suggestionsBox.style.display = 'block';
            } else {
                suggestionsBox.style.display = 'none';
            }
        });

        document.addEventListener('click', function(e) {
            if (!suggestionsBox.contains(e.target) && e.target !== searchInput) {
                suggestionsBox.style.display = 'none';
            }
        });

        function calculateTariff() {
            if (isLoading) {
                alert('Tariff data is still loading. Please wait...');
                return;
            }

            const input = document.getElementById('searchInput').value.trim().toLowerCase();
            const assessableValue = parseFloat(document.getElementById('assessableValue').value);

            if (!input) {
                alert("Please enter HS Code or Tariff Description.");
                return;
            }
            if (isNaN(assessableValue) || assessableValue <= 0) {
                alert("Please enter a valid Assessable Value.");
                return;
            }

            let item = null;

            // Try exact HS match first
            item = tariffData.find(d => d.hs === input);

            // If not found, try partial description match
            if (!item) {
                item = tariffData.find(d =>
                    d.desc.toLowerCase().includes(input)
                );
            }

            const resultBox = document.getElementById('resultBox');
            if (!item) {
                resultBox.style.display = 'block';
                document.getElementById('res-hscode').textContent = "—";
                document.getElementById('res-desc').textContent = "No matching tariff found.";
                document.getElementById('res-cd').textContent = "—";
                document.getElementById('res-sd').textContent = "—";
                document.getElementById('res-vat').textContent = "—";
                document.getElementById('res-ait').textContent = "—";
                document.getElementById('res-rd').textContent = "—";
                document.getElementById('res-at').textContent = "—";
                document.getElementById('res-total').textContent = "—";
                document.getElementById('res-payable').textContent = "—";
                return;
            }

            // Parse rates
            const cdRate = item.cd || 0;
            const sdVal = item.sd || 0;
            const vatRate = item.vat || 0;
            const aitRate = item.ait || 0;
            const rdRate = item.rd || 0;
            const atRate = item.at || 0;

            // CD is % of assessable value
            const cdAmount = (cdRate / 100) * assessableValue;
            // SD can be fixed or % — treat as fixed if >100, else %
            const sdAmount = (sdVal > 100) ? sdVal : (sdVal / 100) * assessableValue;
            // Customs Value = Assessable + CD + SD
            const customsValue = assessableValue + cdAmount + sdAmount;
            // VAT, AIT, RD, AT are % of customs value
            const vatAmount = (vatRate / 100) * customsValue;
            const aitAmount = (aitRate / 100) * customsValue;
            const rdAmount = (rdRate / 100) * customsValue;
            const atAmount = (atRate / 100) * customsValue;

            const totalTax = cdAmount + sdAmount + vatAmount + aitAmount + rdAmount + atAmount;
            const totalPayable = assessableValue + totalTax;

            // Display
            document.getElementById('res-hscode').textContent = item.hs;
            document.getElementById('res-desc').textContent = item.desc;
            document.getElementById('res-cd').textContent = `${cdRate}% → BDT ${cdAmount.toFixed(2)}`;
            document.getElementById('res-sd').textContent = (sdVal > 100 ? `Fixed BDT ${sdVal}` : `${sdVal}%`) + ` → BDT ${sdAmount.toFixed(2)}`;
            document.getElementById('res-vat').textContent = `${vatRate}% → BDT ${vatAmount.toFixed(2)}`;
            document.getElementById('res-ait').textContent = `${aitRate}% → BDT ${aitAmount.toFixed(2)}`;
            document.getElementById('res-rd').textContent = `${rdRate}% → BDT ${rdAmount.toFixed(2)}`;
            document.getElementById('res-at').textContent = `${atRate}% → BDT ${atAmount.toFixed(2)}`;
            document.getElementById('res-total').textContent = `BDT ${totalTax.toFixed(2)}`;
            document.getElementById('res-payable').textContent = `BDT ${totalPayable.toFixed(2)}`;

            resultBox.style.display = 'block';
        }
    </script>
</body>
</html>
